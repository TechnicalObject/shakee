{% comment %}
  Renders product media in various different layouts, depending on the settings in the section.

  Accepts:
    - id: {String} The instance id (required)
    - section_id: The section ID (optional)
    - type: {String} The type of media layout eg. slider, thumbnails (required)
    - product: {Object} The product object (required)
    - section: {Object} The section object (required)
    - device: {String} The device type eg. desktop, mobile (required)
    - has_pagination: {Boolean} Whether to show pagination (optional)
    - enable_peep: {Boolean} Whether to enable peep (optional)
    - is_quick_view: {Boolean} Whether the media is being rendered in quick view (optional)
    - hide_out_of_stock_variants: {Boolean} Whether to hide out of stock variants (optional)
    - change_variant_based_on_thumbnail: {Boolean} Whether to change the variant based on the thumbnail (optional)
    - onboarding: {Boolean} Whether to render an onboarding product media when product media size is 0 (eg. Featured Product) (optional)
  
  Usage:
    {% render product_media with id: 'product-media', product: product, section: section, device: 'mobile', has_pagination: true, enable_peep: true %}
{% endcomment %}

{{ 'component-product-media.min.css' | asset_url | stylesheet_tag }}

{% style %}
  {% if device == 'mobile' %}
    @media (max-width: 767px) {
      #{{ id }} {
        visibility: visible;
        height: unset;
      }
    }

    @media (min-width: 768px) {
      #{{ id }} {
        visibility: hidden;
        height: 0;
      }

      #{{ id }} deferred-media {
        display: none;
      }
    }
  {% elsif device == 'desktop' %}
    @media (max-width: 767px) {
      #{{ id }} {
        visibility: hidden;
        height: 0;
      }

      #{{ id }} deferred-media {
        display: none;
      }
    }

    @media (min-width: 768px) {
      #{{ id }} {
        visibility: visible;
        height: unset;
      }
    }
  {% endif %}
  [data-product-badge] {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    position: absolute;
    top: 1rem;
    left: 1rem;
    z-index: 2;
    scale: 1.3;
    margin-left: 30px;
    margin-top: 5px;
  }

  .badge {
    flex-shrink: 0;
  }

  /* Variant image styling */
  .variant-main-item img {
    border-radius: var(--block-border-radius, 8px) !important;
    width: 100%;
    height: auto;
    background-color: var(--product-card-background-color) !important;
  }

  .variant-thumb-item img {
    border-radius: var(--thumbnail-border-radius, 4px) !important;
    width: 100px !important;
    height: 100px !important;
    object-fit: cover !important;
    background-color: var(--product-card-background-color) !important;
  }

  /* Active thumbnail styling */
  .variant-thumb-item img.active {
    border: 2px solid #000 !important;
  }

  /* Main image container with navigation */
  .variant-main-image {
    position: relative;
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }

  /* Loader overlay for main image */
  .variant-main-image {
    position: relative;
  }

  .variant-main-image .main-image-loader {
    position: absolute;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.6);
    z-index: 4;
    pointer-events: all;
  }

  .variant-main-image.is-loading .main-image-loader {
    display: flex;
  }

  .main-image-loader .spinner {
    width: 36px;
    height: 36px;
    border: 3px solid #e0e0e0;
    border-top-color: #111;
    border-radius: 50%;
    animation: pm-spin 0.8s linear infinite;
  }

  @keyframes pm-spin {
    to { transform: rotate(360deg); }
  }

  /* Optional: subtle blur on the image while loading */
  .variant-main-image.is-loading .variant-main-item img {
    filter: blur(2px);
  }

  /* Navigation arrows for main image */
  .main-image-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 3;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .main-image-nav:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    transform: translateY(-50%) scale(1.05);
  }

  .main-image-nav.prev {
    left: 10px;
  }

  .main-image-nav.next {
    right: 10px;
  }

  .main-image-nav svg {
    width: 20px;
    height: 20px;
    stroke: #333;
    stroke-width: 2;
  }

  /* Hide arrows when there's only one image */
  .variant-thumbnail-group[data-single-image="true"] ~ .variant-main-image .main-image-nav {
    display: none;
  }

  /* Scrollable thumbnail container */
  .variant-thumbnails {
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: thin;
    scrollbar-color: #ccc transparent;
  }

  .variant-thumbnails::-webkit-scrollbar {
    height: 6px;
  }

  .variant-thumbnails::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .variant-thumbnails::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
  }

  .variant-thumbnails::-webkit-scrollbar-thumb:hover {
    background: #999;
  }

  .variant-thumbnail-group {
    flex-wrap: nowrap !important;
  }

  .variant-thumb-item {
    flex-shrink: 0;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .variant-main-item img {
      max-width: 100%;
    }

    .variant-thumb-item img {
      width: 80px !important;
      height: 80px !important;
    }

    .main-image-nav {
      width: 36px;
      height: 36px;
    }

    .main-image-nav svg {
      width: 16px;
      height: 16px;
    }

    .main-image-nav.prev {
      left: 5px;
    }

    .main-image-nav.next {
      right: 5px;
    }
  }
{% endstyle %}

{% liquid 
  assign image_crop = section.settings.image_shape

  unless section_id
    assign section_id = section.id
  endunless

  assign thumbnail_position = section.settings.thumbnail_position
  if device == 'mobile'
    assign thumbnail_position = 'below'
  endif

  assign custom_aspect_ratio = false
  if image_crop != 'original'
    assign custom_aspect_ratio = true
  endif

  if image_crop == 'adapt_to_first_image'
    assign first_image_ratio = product.media.first.preview_image.aspect_ratio
    assign adapt_ratio = 1 | divided_by: first_image_ratio | times: 100
  endif

  assign change_variant_based_on_thumbnail = false
  for block in section.blocks
    case block.type
      when "options"
        if block.settings.thumbnail_changes_variant == true
          assign change_variant_based_on_thumbnail = true
        endif
    endcase
  endfor

  assign enable_video_loop = section.settings.enable_video_loop
  assign enable_autoplay = section.settings.enable_autoplay
  assign show_video_controls = section.settings.show_video_controls

  comment
    Product badges
  endcomment
  assign preorder_string = 'products.product.preorder' | t | downcase
  assign preorder_product = false

  for tag in product.tags
    assign lowercase_tag = tag | downcase
    if lowercase_tag contains preorder_string
      assign preorder_product = true
    endif
    assign lowercase_tag = tag | downcase
    if lowercase_tag contains preorder_string
      assign preorder_product = true
    endif
    if preorder_product == false and tag contains '_badge:'
      assign custom_badge = tag | remove: '_badge:'
    endif
  endfor
%}

<safe-load-scripts class="hidden">
  <script src="{{ 'component-deferred-media.js' | asset_url }}" defer="defer" type="module" data-flow-load-key="deferred-media"></script>
</safe-load-scripts>

<safe-load-scripts class="hidden">
  <script src="{{ 'component-product-media.js' | asset_url }}" defer="defer" type="module" data-flow-load-key="product-media"></script>
</safe-load-scripts>

{% if settings.show_badges %}
  {% capture product_badge %}
    {% if product != blank %}
      {% if product.available %}
        {% comment %} Always show sale/discount badge if applicable {% endcomment %}
        {% render 'badge' with badge: 'sale', badge_product: product, use_variant: true %}
        
        {% comment %} Show preorder badge {% endcomment %}
        {% if preorder_product %}
          {% render 'badge' with badge: 'preorder', preorder_badge: preorder_string %}
        {% endif %}
        
        {% comment %} Show up to 2 custom badges from tags {% endcomment %}
        {% assign custom_badge_count = 0 %}
        {% for tag in product.tags %}
          {% if tag contains '_badge:' and custom_badge_count < 2 %}
            {% assign custom_badge_text = tag | remove: '_badge:' %}
            {% render 'badge' with badge: 'custom', custom_badge: custom_badge_text %}
            {% assign custom_badge_count = custom_badge_count | plus: 1 %}
          {% endif %}
        {% endfor %}
      {% else %}
        {% render 'badge' with badge: 'sold-out', badge_product: product %}
      {% endif %}
    {% else %}
      {% render 'badge' with badge: 'sold-out' %}
    {% endif %}
  {% endcapture %}
{% endif %}

<product-media 
  id="{{ id }}"
  data-device="{{ device }}"
  data-image-size="{{ section.settings.image_size }}"
  data-image-cropped="{{ custom_aspect_ratio }}"
  data-section-id="{{ section_id }}"
  data-peep-enabled="{% if device == 'mobile' and enable_peep == true %}true{% else %}false{% endif %}"
  data-pagination-enabled="{% if has_pagination %}true{% else %}false{% endif %}"
  data-thumbnail-position="{{ thumbnail_position }}"
  data-media-type="{{ type }}"
  data-media-count="{% if onboarding and product.media.size == 0 %}3{% else %}{{ product.media.size }}{% endif %}"
  data-autoplay-enabled="{% if enable_autoplay %}true{% else %}false{% endif %}"
  data-selected-variant="{{ product.selected_or_first_available_variant | json | escape }}"
  class="product-media-slider product-media-slider-{{ device }} thumbnails-{{ thumbnail_position }} media-type-{{ type }}{% if product.media.size == 1 or product.media.size == 0 and onboarding == false %} single-media{% endif %}"
  {% if change_variant_based_on_thumbnail %}
    data-change-variant-based-on-thumbnail="true"
  {% endif %}
  data-quick-view="{% if is_quick_view %}true{% else %}false{% endif %}"
>
  {% if product.media.size > 0 or onboarding %}
    {% comment %} ==== MAIN SLIDER ==== {% endcomment %}
    <div data-media-main data-slider-main class="{% if type == 'thumbnails' %}thumbnail-media--main-media{% else %}product-media-slider-main{% endif %} swiper{% if custom_aspect_ratio %} custom-aspect-ratio{% endif %}{% if product.media.size == 1 %} media--single{% endif %}{% unless enable_peep %} block-radius-clip{% endunless %}">
      {% comment %} ==== BADGES ==== {% endcomment %}
      <div data-product-badge{% if settings.border_radius == 'round' %} class="product-media-badge--extra-spacing"{% endif %}>
        {{ product_badge }}
      </div>


      {% comment %} Check if selected variant has any metafield images {% endcomment %}
      {% assign selected_variant = product.selected_or_first_available_variant %}
      {% assign has_variant_images = false %}
      {% if selected_variant.metafields.custom.variant_images %}
        {% assign has_variant_images = true %}
      {% endif %}

      {% if has_variant_images %}

        {% comment %} ==== MAIN VARIANT IMAGE DISPLAY ==== {% endcomment %}
        <div class="variant-media-container">
          <!-- Main large image display -->
          <div class="variant-main-image" aria-busy="false">
            {% for variant in product.variants %}
              {% comment %} Main featured image for each variant {% endcomment %}
              {% if variant.featured_media %}
                <div class="variant-main-item" data-variant-id="{{ variant.id }}" style="{%  unless product.selected_or_first_available_variant.id == variant.id %}display:none;{% endunless %}">
                  <img src="{{ variant.featured_media | image_url: width: 1445 }}"
                    alt="{% if variant.featured_media.alt != blank %}{{ variant.featured_media.alt }}{% else %}{{ product.title }} - {{ variant.title }}{% endif %}"
                    class="theme-img media-ratio--{{ image_crop }}"
                    width="{{ variant.featured_media.width }}"
                    height="{{ variant.featured_media.height }}"
                    sizes="(min-width: 1200px) calc((1200px - 10rem) / 2), (min-width: 750px) calc((100vw - 11.5rem) / 2), calc(100vw - 4rem)"
                    loading="eager"
                    style="pointer-events: auto;"
                  >
                </div>
              {% else %}
                {% comment %} If no featured image, show first metafield image as main {% endcomment %}
                {% assign first_variant_image = variant.metafields.custom.variant_images.value.first %}
                {% if first_variant_image %}
                  <div class="variant-main-item" data-variant-id="{{ variant.id }}" style="{%  unless product.selected_or_first_available_variant.id == variant.id %}display:none;{% endunless %}">
                    <img src="{{ first_variant_image | image_url: width: 1445 }}"
                      alt="{% if first_variant_image.alt != blank %}{{ first_variant_image.alt }}{% else %}{{ product.title }} - {{ variant.title }}{% endif %}"
                      class="theme-img media-ratio--{{ image_crop }}"
                      width="{{ first_variant_image.width }}"
                      height="{{ first_variant_image.height }}"
                      sizes="(min-width: 1200px) calc((1200px - 10rem) / 2), (min-width: 750px) calc((100vw - 11.5rem) / 2), calc(100vw - 4rem)"
                      loading="eager"
                      style="pointer-events: auto;"
                    >
                  </div>
                {% endif %}
              {% endif %}
            {% endfor %}

            <!-- Loader overlay -->
            <div class="main-image-loader" role="status" aria-live="polite" aria-label="Loading image">
              <div class="spinner"></div>
            </div>

            <!-- Navigation arrows -->
            <button class="main-image-nav prev" onclick="navigateMainImage(-1)" aria-label="Previous image">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            
            <button class="main-image-nav next" onclick="navigateMainImage(1)" aria-label="Next image">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <!-- Thumbnail images display -->
          <div class="variant-thumbnails" style="display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px;">
            {% for variant in product.variants %}
              {% comment %} Show thumbnails for each variant {% endcomment %}
              <div class="variant-thumbnail-group" data-variant-id="{{ variant.id }}" style="display: flex; flex-wrap: nowrap; gap: 10px; {%  unless product.selected_or_first_available_variant.id == variant.id %}display:none;{% endunless %}">

                {% comment %} Always show the first image (featured or first metafield) as thumbnail {% endcomment %}
                {% if variant.featured_media %}
                  <div class="variant-thumb-item" onclick="updateMainImage('{{ variant.featured_media | image_url: width: 1445 }}', '{{ variant.featured_media.alt | escape }}')">
                    <img src="{{ variant.featured_media | image_url: width: 150 }}"
                      alt="{{ variant.featured_media.alt | default: product.title }}"
                      style="cursor: pointer; border: 2px solid transparent;"
                      class="{% if forloop.first and product.selected_or_first_available_variant.id == variant.id %}active{% endif %}"
                      onmouseover="this.style.borderColor='#000'"
                      onmouseout="if(!this.classList.contains('active')) this.style.borderColor='transparent'"
                    >
                  </div>
                {% else %}
                  {% comment %} If no featured image, show first metafield image as thumbnail {% endcomment %}
                  {% assign first_variant_image = variant.metafields.custom.variant_images.value.first %}
                  {% if first_variant_image %}
                    <div class="variant-thumb-item" onclick="updateMainImage('{{ first_variant_image | image_url: width: 1445 }}', '{{ first_variant_image.alt | escape }}')">
                      <img src="{{ first_variant_image | image_url: width: 150 }}"
                        alt="{% if first_variant_image.alt != blank %}{{ first_variant_image.alt }}{% else %}{{ product.title }} - {{ variant.title }}{% endif %}"
                        style="cursor: pointer; border: 2px solid transparent;"
                        class="{% if product.selected_or_first_available_variant.id == variant.id %}active{% endif %}"
                        onmouseover="this.style.borderColor='#000'"
                        onmouseout="if(!this.classList.contains('active')) this.style.borderColor='transparent'"
                      >
                    </div>
                  {% endif %}
                {% endif %}

                {% comment %} Show remaining metafield images as thumbnails {% endcomment %}
                {% for image in variant.metafields.custom.variant_images.value %}
                  {% comment %} Skip first image if no featured image exists (already shown above) {% endcomment %}
                  {% unless variant.featured_media == blank and forloop.first %}
                    <div class="variant-thumb-item" onclick="updateMainImage('{{ image | image_url: width: 1445 }}', '{{ image.alt | escape }}')">
                      <img src="{{ image | image_url: width: 150 }}"
                        alt="{% if image.alt != blank %}{{ image.alt }}{% else %}{{ product.title }} - {{ variant.title }}{% endif %}"
                        style="cursor: pointer; border: 2px solid transparent;"
                        onmouseover="this.style.borderColor='#000'"
                        onmouseout="if(!this.classList.contains('active')) this.style.borderColor='transparent'"
                      >
                    </div>
                  {% endunless %}
                {% endfor %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        {% comment %} ==== SLIDES ==== {% endcomment %}
        <div class="swiper-wrapper">
          {% if product.media.size > 0 %}
            {% comment %} Show product media only if NO variant metafields exist {% endcomment %}
            {% unless has_variant_images %}
              {% for media in product.media %}
                {% comment %}
                  If this media is assigned to any variant that is available, keep showing the thumbnail.
                  EVERY variant with this media needs to be unavailable for it to be hidden.
                {% endcomment %}
                {% liquid 
                  assign hideThumb = false
                  assign mediaHasVariant = false

                  if hide_out_of_stock_variants
                    assign hideThumb = true
                    for option in product.options_with_values
                      for option_value in option.values
                        if option_value.variant.featured_media.id == media.id
                          assign mediaHasVariant = true

                          if option_value.variant.available
                            assign hideThumb = false
                          endif
                        endif
                      endfor
                    endfor
                  endif
                %}

                {% unless hideThumb and mediaHasVariant %}
                  <div 
                    class="swiper-slide{% if product.media.size == 1 %} animated fadeIn{% endif %}{% if enable_peep %} block-radius-clip{% endif %}"
                    {%- if product.media.size > 1 -%}
                      style="visibility:hidden;"
                    {%- endif -%}
                    data-media-type="{{ media.media_type }}"
                    data-media-id="{{ media.id }}"
                    {%- assign found = false -%}
                    {%- for option in product.options_with_values -%}
                      {%- for value in option.values -%}
                        {%- liquid 
                          assign is_combined_listing = false
                          if value.product_url != blank
                            assign is_combined_listing = true
                            assign item_url = value.product_url | append: '?variant=' | append: value.variant.id
                            assign product_url = value.product_url
                          else
                            assign item_url = value.variant.url
                            assign product_url = value.variant.product.url
                          endif
                        -%}
                        {%- if found == false and value.variant.featured_media.id == media.id -%}
                          data-variant="{{ value.variant | json | escape }}"
                          data-is-combined-listing="{{ is_combined_listing }}"
                          data-product-fetch-url="{{ item_url }}"
                          data-product-url="{{ product_url }}"
                          {%- assign found = true -%}
                        {%- endif -%}
                      {%- endfor -%}
                    {%- endfor -%}
                  >
                    {% if media.media_type == 'image' %}
                      <a 
                        data-main-media-link
                        href="{{ media.preview_image | image_url: width: 1445 }}"
                        data-pswp-width="{{ media.width }}"
                        data-pswp-height="{{ media.height }}"
                        target="_blank"
                        {% if adapt_ratio %}style="padding-bottom: {{ adapt_ratio }}%;"{% endif %}
                        {% if settings.animations_enabled %}class="kb-enabled"{% endif %}
                      >

                      <img
                        class="theme-img media-ratio--{{ image_crop }}"
                        src="{{ media.preview_image | image_url: width: 1445 }}"
                        alt="{% if media.alt != product.title %}{{ media.alt }}{% endif %}"
                        width="{{ media.width }}"
                        height="{{ media.height }}"
                        sizes="(min-width: 1200px) calc((1200px - 10rem) / 2), (min-width: 750px) calc((100vw - 11.5rem) / 2), calc(100vw - 4rem)"
                        loading="eager"
                      />
                    
                      </a>
                    {% else %}
                      {% render 'deferred-media' with delayed_media: media, section_id: section_id, enable_video_loop: enable_video_loop, enable_autoplay: enable_autoplay, media_wrapper_classes: 'product-single__media__wrapper', aspect_ratio: image_crop, media_product: product, media_type: 'slider', show_controls: show_video_controls %}
                    {% endif %}

                    
                    {%- if media.media_type == 'model' -%}
                      <div class="button-wrap view-in-space--wrapper">
                        <button
                          type="button"
                          aria-label="{{ 'products.product.view_in_space_label' | t }}"
                          class="btn product-medias__view-in-space"
                          data-shopify-xr
                          data-shopify-model3d-id="{{ media.id }}"
                          data-shopify-title="{{ product.title | escape }}"
                          data-shopify-xr-hidden
                        >
                          {{ 'products.product.view_in_space' | t }}
                        </button>
                      </div>
                    {%- endif -%}

                    {%- if first_3d_model -%}
                      <script type="application/json" id="ProductJSON-{{ product.id }}">
                        {{ product.media | where: 'media_type', 'model' | json }}
                      </script>
                    {%- endif -%}

                    <script type="application/json" id="ProductJSON-{{ product.id }}">
                      {{ product.media | where: 'media_type', 'model' | json }}
                    </script>
                  </div>
                {% endunless %}
              {% endfor %}
            {% endunless %}
          {% else %}
            {% comment %} Onboarding placeholder slides {% endcomment %}
            {% assign svg_classes = 'icon icon--placeholder block-radius media-ratio--' | append: image_crop %}
            {% for i in (1..3) %}
              <div class="swiper-slide" style="visibility:hidden;">
                {% assign svg_name = 'product-' | append: i %}
                {{ svg_name | placeholder_svg_tag: svg_classes }}
              </div>
            {% endfor %}
          {% endif %}
        </div>

        {% comment %} ==== PAGINATION ==== {% endcomment %}
        {% if has_pagination %}
          <div class="media-slider-navigation arrows input-radius-clip">
            <a href="#" class="flex-prev arrow-prev-{{ id }}-{{ section_id }} standalone-icon--wrapper">
              {% render 'theme-icon' with icon: 'chevron_left', iconWidth: 24, iconHeight: 24, iconColor: 'currentColor' %}
            </a>

            <div class="swiper-pagination-{{ id }}-{{ section_id }}"></div>

            <a href="#" class="flex-next arrow-next-{{ id }}-{{ section_id }} standalone-icon--wrapper">
              {% render 'theme-icon' with icon: 'chevron_right', iconWidth: 24, iconHeight: 24, iconColor: 'currentColor' %}
            </a>
          </div>
        {% endif %}

        {% if type == 'thumbnails' %}
          <a href="#" class="thumb-prev arrow-prev-{{ id }}-{{ section_id }}">
            {% render 'theme-icon' with icon: 'chevron_left', iconWidth: 24, iconHeight: 24, iconColor: 'currentColor' %}
          </a>

          <a href="#" class="thumb-next arrow-next-{{ id }}-{{ section_id }}">
            {% render 'theme-icon' with icon: 'chevron_right', iconWidth: 24, iconHeight: 24, iconColor: 'currentColor' %}
          </a>
        {% endif %}
      {% endif %}
    </div>

    {% comment %} ==== THUMBNAILS ==== {% endcomment %}
    {% if type == 'thumbnails' %}
      {% if product.media.size > 1 or onboarding %}
        <div 
                      data-updates-on-change
                      data-update-id="item-title" data-media-thumbnails class="thumbnail-media--thumbnails swiper">
          <div class="swiper-wrapper">
            {% if product.media.size > 0 %}

              {% comment %} Show product media only if NO variant metafields exist {% endcomment %}
              {% unless has_variant_images %}
                {% for media in product.media %}
                  {% comment %}
                    If this media is assigned to any variant that is available, keep showing the thumbnail.
                    EVERY variant with this media needs to be unavailable for it to be hidden.
                  {% endcomment %}

                  {% liquid 
                    assign hideThumb = false
                    assign mediaHasVariant = false

                    if hide_out_of_stock_variants
                      assign hideThumb = true
                      for option in product.options_with_values
                        for option_value in option.values
                          if option_value.variant.featured_media.id == media.id
                            assign mediaHasVariant = true

                            if option_value.variant.available
                              assign hideThumb = false
                            endif
                          endif
                        endfor
                      endfor
                    endif
                  %}

                  {% unless hideThumb and mediaHasVariant %}
                    <div class="swiper-slide"
                      {%- if product.media.size > 1 -%}
                        style="visibility:hidden;"
                      {%- endif -%}
                    >
                      {% if media.media_type == 'model' %}
                        <div class="product-medias__emblem">
                          {% render 'theme-icon' with icon: 'cube', iconSize: 20 %}
                        </div>
                      {% elsif media.media_type == 'video' or media.media_type == 'external_video' %}
                        <div class="product-medias__emblem">
                          {% render 'theme-icon' with icon: 'play', iconSize: 20 %}
                        </div>
                      {% endif %}

                      {% capture props %}
                        data-image-id="{{ media.id }}"
                        data-max-width="{{ media.preview_image.width }}"
                      {% endcapture %}

                      {% capture styles %}max-width: {{ media.preview_image.width }}px;{% endcapture %}
                      {% capture class %}
                        product-medias__thumbnail__image product-medias__thumbnail--{{ media.media_type }} media-ratio--{{ image_crop }} thumbnail-radius
                      {% endcapture %}

                      {% capture thumbalt %}
                        {% if media.alt == product.title %}
                          {{ null }}
                        {% elsif media.media_type == 'video' or media.media_type == 'external_video' %}
                          {{ 'products.product.video_thumbnail_alt' | t: imageAlt: media.alt | escape }}
                        {% elsif media.media_type == 'model' %}
                          {{ 'products.product.model_thumbnail_alt' | t: imageAlt: media.alt | escape }}
                        {% else %}
                          {{ media.alt }}
                        {% endif %}
                      {% endcapture %}

                      {% render 'responsive-image' with media.preview_image, wrapper_class: 'thumbnail-radius', class: class, alt: thumbalt | escape, default_size: '300x', props: props, blur: false, styles: styles, adaptive_ratio: adapt_ratio %}
                    </div>
                  {% endunless %}
                {% endfor %}
              {% endunless %}
            {% else %}
              {% comment %} Onboarding placeholder thumbnails {% endcomment %}
              {% assign svg_classes = 'icon icon--placeholder thumbnail-radius product-medias__thumbnail__image product-medias__thumbnail--image media-ratio--' | append: image_crop %}
              {% for i in (1..3) %}
                <div class="swiper-slide" style="visibility:hidden;">
                  {% assign svg_name = 'product-' | append: i %}
                  {{ svg_name | placeholder_svg_tag: svg_classes }}
                </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endif %}
  {% else %}
    {% comment %} ==== BADGES ==== {% endcomment %}
    <div data-product-badge>
      {{ product_badge }}
    </div>
    
    {% comment %} ==== PLACEHOLDER ==== {% endcomment %}
    {% assign svg_classes = 'icon icon--placeholder block-radius media-ratio--' | append: image_crop %}
    {{ 'product-1' | placeholder_svg_tag: svg_classes }}
  {% endif %}
</product-media>

<script>
let currentImageIndex = 0;
let currentVariantImages = [];
let lastSelectedVariantId = null; // Track the last selected variant

// Function to get the current device type based on screen width
function getCurrentDevice() {
  return window.innerWidth >= 768 ? 'desktop' : 'mobile';
}

// Function to get the active media container based on current device
function getActiveMediaContainer() {
  const currentDevice = getCurrentDevice();
  const containers = document.querySelectorAll('[data-device]');
  
  for (let container of containers) {
    const containerDevice = container.getAttribute('data-device');
    const computedStyle = window.getComputedStyle(container);
    
    if (containerDevice === currentDevice && computedStyle.visibility === 'visible') {
      return container;
    }
  }
  
  return null;
}

// Function to get all images for current variant (device-aware)
function getCurrentVariantImages(variantId) {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return [];
  
  const thumbnailGroup = activeContainer.querySelector(`.variant-thumbnail-group[data-variant-id="${variantId}"]`);
  if (!thumbnailGroup) return [];
  
  const images = [];
  const thumbnails = thumbnailGroup.querySelectorAll('.variant-thumb-item img');
  
  thumbnails.forEach(thumb => {
    const largeSrc = thumb.src.replace('width=150', 'width=1445');
    images.push({
      src: largeSrc,
      alt: thumb.alt
    });
  });
  
  return images;
}

// Function to navigate main image (direction: -1 for prev, 1 for next)
function navigateMainImage(direction) {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return;
  
  const selectedVariantId = getSelectedVariantId();
  if (!selectedVariantId) return;
  
  currentVariantImages = getCurrentVariantImages(selectedVariantId);
  if (currentVariantImages.length <= 1) return;
  
  currentImageIndex += direction;
  
  if (currentImageIndex >= currentVariantImages.length) {
    currentImageIndex = 0;
  } else if (currentImageIndex < 0) {
    currentImageIndex = currentVariantImages.length - 1;
  }
  
  const newImage = currentVariantImages[currentImageIndex];
  updateMainImage(newImage.src, newImage.alt);
  updateActiveThumbnail(selectedVariantId, currentImageIndex);
}

// Function to get selected variant ID with fallback to global state
function getSelectedVariantId() {
  // First, try to get from form selectors
  const variantSelector = document.querySelector('input[name="id"]:checked') || 
                         document.querySelector('select[name="id"]') || 
                         document.querySelector('.variant-selector:checked') ||
                         document.querySelector('.variant-selector');
  
  if (variantSelector && variantSelector.value) {
    lastSelectedVariantId = variantSelector.value;
    return variantSelector.value;
  }
  
  // If no form selector found, use the last known selected variant
  if (lastSelectedVariantId) {
    return lastSelectedVariantId;
  }
  
  // Fallback to checking visible main image in active container
  const activeContainer = getActiveMediaContainer();
  if (activeContainer) {
    const visibleMainImage = activeContainer.querySelector('.variant-main-item[style*="display: block"], .variant-main-item:not([style*="display: none"])');
    if (visibleMainImage) {
      const variantId = visibleMainImage.getAttribute('data-variant-id');
      lastSelectedVariantId = variantId;
      return variantId;
    }
  }
  
  // Final fallback to default variant
  const defaultVariantId = {{ product.selected_or_first_available_variant.id | json }};
  lastSelectedVariantId = defaultVariantId;
  return defaultVariantId;
}

// Function to update active thumbnail (device-aware)
function updateActiveThumbnail(variantId, index) {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return;
  
  const thumbnailGroup = activeContainer.querySelector(`.variant-thumbnail-group[data-variant-id="${variantId}"]`);
  if (!thumbnailGroup) return;
  
  const thumbnails = thumbnailGroup.querySelectorAll('.variant-thumb-item img');
  
  thumbnails.forEach((thumb, i) => {
    thumb.classList.remove('active');
    thumb.style.borderColor = 'transparent';
    
    if (i === index) {
      thumb.classList.add('active');
      thumb.style.borderColor = '#000';
    }
  });
}

// Function to update the main image when thumbnail is clicked (device-aware)
function updateMainImage(imageSrc, imageAlt) {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return;
  
  const selectedVariantId = getSelectedVariantId();
  
  if (selectedVariantId) {
    const mainImageContainer = activeContainer.querySelector(`.variant-main-item[data-variant-id="${selectedVariantId}"]`);
    const wrapper = activeContainer.querySelector('.variant-main-image');
    
    if (mainImageContainer) {
      const mainImage = mainImageContainer.querySelector('img');
      if (mainImage) {
        // Skip if already showing this image
        if (mainImage.src === imageSrc) return;

        // Show loader
        toggleMainImageLoader(activeContainer, true);

        // Keep the slight visual dim
        mainImageContainer.style.opacity = '0.7';
        mainImageContainer.style.transition = 'opacity 0.2s ease';
        
        // Preload new image
        const newImage = new Image();
        newImage.onload = function() {
          mainImage.src = imageSrc;
          mainImage.alt = imageAlt || '';
          mainImageContainer.style.opacity = '1';

          // Update state
          currentVariantImages = getCurrentVariantImages(selectedVariantId);
          currentImageIndex = currentVariantImages.findIndex(img => img.src === imageSrc);
          if (currentImageIndex === -1) currentImageIndex = 0;

          // Hide loader
          toggleMainImageLoader(activeContainer, false);
        };
        newImage.onerror = function() {
          mainImageContainer.style.opacity = '1';
          toggleMainImageLoader(activeContainer, false);
        };
        newImage.src = imageSrc;
      }
    }
  }
}

// Function to preload variant images (device-aware)
function preloadVariantImages(variantId) {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return;
  
  const thumbnailGroup = activeContainer.querySelector(`.variant-thumbnail-group[data-variant-id="${variantId}"]`);
  if (thumbnailGroup) {
    const thumbnails = thumbnailGroup.querySelectorAll('.variant-thumb-item img');
    thumbnails.forEach(thumb => {
      const largeSrc = thumb.src.replace('width=150', 'width=1445');
      const img = new Image();
      img.src = largeSrc; // This triggers preloading
    });
  }
}

// Function to scroll thumbnails to the beginning (device-aware)
function scrollThumbnailsToStart() {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return;
  
  const thumbnailContainer = activeContainer.querySelector('.variant-thumbnails');
  if (thumbnailContainer) {
    thumbnailContainer.scrollTo({
      left: 0,
      behavior: 'smooth'
    });
  }
}

// Function to update variant images visibility (device-aware)
function updateVariantImages(selectedVariantId) {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return;

  // Store the selected variant ID globally
  lastSelectedVariantId = selectedVariantId;
  
  // Update main images
  const mainImages = activeContainer.querySelectorAll('.variant-main-item');
  mainImages.forEach(item => {
    const itemVariantId = item.getAttribute('data-variant-id');
    item.style.display = (itemVariantId === selectedVariantId.toString()) ? 'block' : 'none';
  });

  // Update thumbnail groups
  const thumbnailGroups = activeContainer.querySelectorAll('.variant-thumbnail-group');
  thumbnailGroups.forEach(group => {
    const groupVariantId = group.getAttribute('data-variant-id');
    group.style.display = (groupVariantId === selectedVariantId.toString()) ? 'flex' : 'none';
  });

  // Reset main image to the first thumbnail for the selected variant (use loader-aware path)
  const selectedVariantContainer = activeContainer.querySelector(`.variant-main-item[data-variant-id="${selectedVariantId}"]`);
  if (selectedVariantContainer) {
    const thumbnailGroup = activeContainer.querySelector(`.variant-thumbnail-group[data-variant-id="${selectedVariantId}"]`);
    if (thumbnailGroup) {
      const firstThumbnail = thumbnailGroup.querySelector('.variant-thumb-item img');
      if (firstThumbnail) {
        const mainImageSrc = firstThumbnail.src.replace('width=150', 'width=1445');
        const mainImageAlt = firstThumbnail.alt;

        // Use the same loader/preload logic as thumbnail clicks
        updateMainImage(mainImageSrc, mainImageAlt);
      }
    }
  }

  // Set the first thumbnail as active
  setActiveFirstThumbnail(selectedVariantId);

  // Scroll and preload
  scrollThumbnailsToStart();
  preloadVariantImages(selectedVariantId);

  // Update legacy variant images (if they exist)
  const variantImages = activeContainer.querySelectorAll('.variant-image-item');
  variantImages.forEach(item => {
    const itemVariantId = item.getAttribute('data-variant-id');
    const img = item.querySelector('img');
    
    if (itemVariantId === selectedVariantId.toString()) {
      item.style.display = 'block';
      if (img) img.style.display = 'block';
    } else {
      item.style.display = 'none';
      if (img) img.style.display = 'none';
    }
  });
}

// Function to set the first thumbnail as active (device-aware)
function setActiveFirstThumbnail(variantId) {
  const activeContainer = getActiveMediaContainer();
  if (!activeContainer) return;
  
  // Remove active class from all thumbnails in active container
  activeContainer.querySelectorAll('.variant-thumb-item img').forEach(thumb => {
    thumb.classList.remove('active');
    thumb.style.borderColor = 'transparent';
  });
  
  // Add active class to the first thumbnail of the selected variant
  const selectedThumbnailGroup = activeContainer.querySelector(`.variant-thumbnail-group[data-variant-id="${variantId}"]`);
  if (selectedThumbnailGroup) {
    const firstThumbnail = selectedThumbnailGroup.querySelector('.variant-thumb-item img');
    if (firstThumbnail) {
      firstThumbnail.classList.add('active');
      firstThumbnail.style.borderColor = '#000';
    }
  }
}

// Add visual feedback to thumbnails (device-aware)
function addThumbnailFeedback() {
  document.addEventListener('click', function(e) {
    if (e.target.closest('.variant-thumb-item')) {
      const activeContainer = getActiveMediaContainer();
      if (!activeContainer) return;
      
      // Only process if the clicked thumbnail is in the active container
      if (!activeContainer.contains(e.target)) return;
      
      // Remove active state from all thumbnails in current variant
      const currentVariantGroup = e.target.closest('.variant-thumbnail-group');
      if (currentVariantGroup) {
        const allThumbs = currentVariantGroup.querySelectorAll('.variant-thumb-item img');
        allThumbs.forEach(thumb => {
          thumb.classList.remove('active');
          thumb.style.borderColor = 'transparent';
        });
        
        // Add active state to clicked thumbnail
        const clickedThumb = e.target.closest('.variant-thumb-item').querySelector('img');
        if (clickedThumb) {
          clickedThumb.classList.add('active');
          clickedThumb.style.borderColor = '#000';
        }
      }
    }
  });
}

// Handle resize events to update when switching between mobile/desktop
function handleResize() {
  // Use the last selected variant or get current selection
  const selectedVariant = getSelectedVariantId();
  if (selectedVariant) {
    // Update the new active container with the current variant selection
    updateVariantImages(selectedVariant);
  }
}

// Debounce resize handler
let resizeTimeout;
window.addEventListener('resize', function() {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(handleResize, 100);
});

function listenForVariantChange() {
  if (!window.eventBus) {
    // Wait a bit and try again
    setTimeout(listenForVariantChange, 50);
    return;
  }

  // Subscribe to variant change events
  window.eventBus.on('variant:change', (data) => {
    console.log('Variant changed:', data);
    if (data && data.variant && data.variant.id) {
      updateVariantImages(data.variant.id);
    }
  });
}

// Also listen for direct variant selector changes (fallback)
document.addEventListener('change', function(e) {
  if (e.target.name === 'id' || e.target.classList.contains('variant-selector')) {
    const selectedVariantId = e.target.value;
    if (selectedVariantId) {
      updateVariantImages(selectedVariantId);
    }
  }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  listenForVariantChange();
  addThumbnailFeedback();
  
  // Set initial state
  const selectedVariant = {{ product.selected_or_first_available_variant.id | json }};
  if (selectedVariant) {
    lastSelectedVariantId = selectedVariant; // Initialize the global state
    updateVariantImages(selectedVariant);
  }
  
  // Preload initial variant images
  if (selectedVariant) {
    preloadVariantImages(selectedVariant);
  }
});

function toggleMainImageLoader(activeContainer, isLoading) {
  const wrapper = activeContainer ? activeContainer.querySelector('.variant-main-image') : null;
  if (!wrapper) return;
  wrapper.classList.toggle('is-loading', !!isLoading);
  wrapper.setAttribute('aria-busy', isLoading ? 'true' : 'false');
}
</script>