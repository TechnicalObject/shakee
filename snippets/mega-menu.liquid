{% liquid 
  assign block = mega-menu

  assign block_grid_cols = '1fr'
  assign links_grid_cols = 'repeat(5, 1fr)'
  if link.links.size > 0 and block.settings.mega_image_1 != blank and block.settings.mega_image_2 != blank
    assign block_grid_cols = '1fr 1fr'
    assign links_grid_cols = 'repeat(3, 1fr)'
  elsif link.links.size > 0 and block.settings.mega_image_1 != blank or block.settings.mega_image_2 != blank
    assign block_grid_cols = '2fr 1fr'
    assign links_grid_cols = 'repeat(4, 1fr)'
  elsif link.links.size == 0 and block.settings.mega_image_1 != blank or block.settings.mega_image_2 != blank
    assign block_grid_cols = 'repeat(5, 1fr)'
  endif

  assign display_type = block.settings.menu_display_type | default: 'list'
%}

{% style %}
  [data-mega-menu-block-id="{{ block.id }}"] {
    grid-template-columns: {{ block_grid_cols }};
  }

  [data-mega-menu-block-id="{{ block.id }}"] .mega-menu--links {
    grid-template-columns: {{ links_grid_cols }};
  }

  [data-mega-menu-block-id="{{ block.id }}"] .mega-menu--links.image-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }

  [data-mega-menu-block-id="{{ block.id }}"] .collection-image-item {
    text-align: center;
  }

  [data-mega-menu-block-id="{{ block.id }}"] .collection-image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    transition: transform 0.3s ease;
  }

  [data-mega-menu-block-id="{{ block.id }}"] .collection-image-item:hover img {
    transform: scale(1.05);
  }

  [data-mega-menu-block-id="{{ block.id }}"] .collection-image-item .collection-name {
    margin-top: 10px;
    font-weight: 500;
    color: var(--color-foreground);
  }

  .mega-menu-block .block-id-{{ block.id }} .overlay-text-on-image-promo-1,
  .mega-menu-block .block-id-{{ block.id }} .overlay-text-on-image-promo-1 a:hover {
    color: rgba({{ block.settings.overlay_text_color_promo_1.rgba }}) !important;
  }

  .mega-menu-block .block-id-{{ block.id }} .overlay-text-on-image-promo-2,
  .mega-menu-block .block-id-{{ block.id }} .overlay-text-on-image-promo-2 a:hover {
    color: rgba({{ block.settings.overlay_text_color_promo_2.rgba }}) !important;
  }
{% endstyle %}

<div class="mega-menu-block{% if link.links.size == 0 and block.settings.mega_image_1 == blank and block.settings.mega_image_2 == blank %} no--content{% if request.design_mode %} no--content-design-mode{% endif %}{% endif %}" data-mega-menu-block-id="{{ block.id }}" {{ block.shopify_attributes }}>
  {% if link.links.size == 0 %}
    {% if block.settings.mega_image_1 == blank and block.settings.mega_image_2 == blank %}
      <p class="mega-menu--empty" {% unless request.design_mode %}style="visibility:hidden;"{% endunless %}>
        {{ 'layout.header.mega_menu_empty' | t }}
      </p>
    {% endif %}
  {% endif %}

  {% if link.links.size > 0 %}
    <div class="mega-menu--links{% if display_type == 'images' %} image-grid{% endif %}">
      {% if display_type == 'list' %}
        {% for sub_link in link.links %}
          <li class="dropdown-submenu nav-link-animated--custom" aria-haspopup="true">
            <div class="inner">
              <p class="h4 mega-menu-link--title"><a class="animated-link--item" href="{{ sub_link.url }}">{{ sub_link.title | escape }}</a></p>
              <ul class="menu-link">
                {% for sub_sub_link in sub_link.links %}
                  <li>
                    <a class="animated-link--item" href="{{ sub_sub_link.url }}">{{ sub_sub_link.title | escape }}</a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </li>
        {% endfor %}
      {% elsif display_type == 'images' %}
        {% for sub_link in link.links %}
          {% assign collection = collections[sub_link.handle] %}
          {% if collection %}
            <div class="collection-image-item">
              <a href="{{ sub_link.url }}">
                {% liquid
                  assign image_to_show = null
                  assign image_alt = collection.title | escape
                  
                  if collection.image
                    assign image_to_show = collection.image
                  elsif collection.products.size > 0 and collection.products.first.featured_image
                    assign image_to_show = collection.products.first.featured_image
                  endif
                %}
                
                {% if image_to_show %}
                  <img src="{{ image_to_show | image_url: width: 300 }}" 
                       alt="{{ image_alt }}" 
                       loading="lazy"
                       width="300"
                       height="150">
                {% else %}
                  <div class="placeholder-image" style="width: 100%; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                    <span>No Image</span>
                  </div>
                {% endif %}
                <p class="collection-name">{{ sub_link.title | escape }}</p>
              </a>
            </div>
          {% else %}
            <div class="collection-image-item">
              <a href="{{ sub_link.url }}">
                <div class="placeholder-image" style="width: 100%; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                  <span>No Collection</span>
                </div>
                <p class="collection-name">{{ sub_link.title | escape }}</p>
              </a>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
  {% endif %}

  {% if block.settings.mega_image_1 or block.settings.mega_image_2 %}
    <div class="mega-menu--promos">
      {% if block.settings.mega_image_1 %}
        <div>
          {% render 'mega-menu-promo-card' with 
            promo_wrapper_classes: "dropdown-submenu",
            promo_block_id: block.id,
            promo_wrapper_attr: "aria-haspopup='true'",
            promo_img: block.settings.mega_image_1,
            promo_img_crop: block.settings.image_1_aspect_ratio,
            promo_text_overlay: block.settings.overlay_text_on_image_promo_1,
            promo_text_heading: block.settings.mega_image_header_1,
            promo_text_subheading: block.settings.mega_image_subheader_1,
            promo_text_color: block.settings.overlay_text_color_promo_1,
            promo_link: block.settings.mega_image_link_1
          %}
        </div>
      {% endif %}

      {% if block.settings.mega_image_2 %}
        <div>
          {% render 'mega-menu-promo-card' with 
            promo_wrapper_classes: "dropdown-submenu",
            promo_block_id: block.id,
            promo_wrapper_attr: "aria-haspopup='true'",
            promo_img: block.settings.mega_image_2,
            promo_img_crop: block.settings.image_2_aspect_ratio,
            promo_text_overlay: block.settings.overlay_text_on_image_promo_2,
            promo_text_heading: block.settings.mega_image_header_2,
            promo_text_subheading: block.settings.mega_image_subheader_2,
            promo_text_color: block.settings.overlay_text_color_promo_2,
            promo_link: block.settings.mega_image_link_2
          %}
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>
